## 简介
纹理映射是高质量图像合成中最成功的新技术之一。它可以极大地增强光栅扫描图像的视觉丰富性，同时只需要相对较小的计算增量。该技术已应用于多种表面属性：表面颜色、表面法线、镜面、透明度、照明和表面位移等。尽管应用广泛，但其核心技术在不同场景下基本相同。

本文梳理纹理映射的基础，可分为两个主题：
- 几何映射：将纹理扭曲并映射到目标表面。
- 抗混叠过滤：在采样与缩放时抑制混叠。

---

## 核心算法与公式

### 一、扫描顺序算法

1) 屏幕扫描（逆向映射）

流程：

```
for y:
  for x:
    计算 u(x, y), v(x, y)
    拷贝 TEX[u, v] -> SCR[x, y]
```

特点：需实时计算纹理坐标，适合硬件实现。

2) 纹理扫描（正向映射）

流程：

```
for v:
  for u:
    计算 x(u, v), y(u, v)
    拷贝 TEX[u, v] -> SCR[x, y]
```

问题：非仿射映射易产生空洞或重叠。

3) 双通道算法

流程：

```
// 第一通道（水平）
for v:
  for u:
    计算 x(u, v)
    拷贝 TEX[u, v] -> TEMP[x, v]

// 第二通道（垂直）
for x:
  for v:
    计算 y(x, v)
    拷贝 TEMP[x, v] -> SCR[x, y]
```

优势：将二维映射分解为两次一维变换，适合流处理。

---

### 二、几何映射算法

1) 平面多边形参数化

三角形（仿射映射）：

```
x_o = A u + B v + C
 y_o = D u + E v + F
 z_o = G u + H v + I
```

四边形（透视映射，齐次坐标形式）：

```
[ x_o w_o, y_o w_o, z_o w_o, w_o ]^T = [ u, v, 1 ]
                                        [ A  D  G  J
                                          B  E  H  K
                                          C  F  I  L ]

真实坐标需齐次除法：
 x_o = (A u + B v + C) / (J u + K v + L)
```

2) 投影变换（透视投影）

```
u = (a x + b y + c) / (g x + h y + i)
v = (d x + e y + f) / (g x + h y + i)
```

增量计算：扫描时每像素约需 3 次加法与 2 次除法（现代 GPU 可融合优化）。

---

### 三、滤波算法（抗锯齿）

1) 直接卷积法 — 椭圆加权平均（EWA）

要点：屏幕像素逆映射为纹理空间中的椭圆。

椭圆判定（二次型）：

$$(u - u_0, v - v_0) M^{-1} (u - u_0, v - v_0)^T \le 1 $$ ，其中 \( M \) 由偏导数矩阵构造。

实现：逐纹理像素判断是否位于椭圆内，并进行加权求和。

2) 预滤波法

- Mipmap 金字塔（Williams, 1983）
  - 构建：逐层降采样（如 \(2^k \times 2^k\)）。
  - 三线性插值：

$$
color = lerp( lerp(tex_l, tex_{l+1}, α),
              lerp(tex_l, tex_{l+1}, β),
              d )
$$

  其中 \(l\) 为金字塔层级，\(d\) 为细节参数。

- 求和面积表（Crow, 1984）
  - 预计算积分图：$$I(u, v) = \sum_{i=0}^{u} \sum_{j=0}^{v} tex(i, j)$$
  - 矩形区域滤波：仅需 4 次查表（角点相减）。

3) 滤波方法对比

| 方法               | 滤波器形状 | 自由度 | 速度代价            |
| ------------------ | ---------- | ------ | ------------------- |
| 点采样             | 点         | 2      | \(O(1)\)           |
| Mipmap 三线性插值  | 正方形     | 3      | 8 次查表 + 7 次乘加 |
| EWA（直接卷积）    | 椭圆       | 5      | 随椭圆面积而变      |
| 求和面积表（Box）  | 矩形       | 4      | 4 次查表 + 3 次加减 |

---

### 四、特殊映射技术

1) 光照映射（Environment Mapping）

反射方向索引示意：\( u = f(\text{反射向量}) \)。高曲率区域需要较大范围的滤波以避免失真。

2) 位移映射（Displacement Mapping）

需切向量场 \(\mathbf{T}_u, \mathbf{T}_v\) 以计算法线扰动：


$$N_new = N + Δu * ∂T_v/∂u + Δv * ∂T_u/∂v$$


---

## 关键结论
- 几何映射：透视投影必须进行齐次除法（仿射映射为特例）。
- 滤波质量：EWA 支持任意椭圆滤波，质量最佳但计算量大；Mipmap 速度快但主要支持近似正方形滤波。
- 预滤波结构：求和面积表适合矩形滤波；Mipmap 内存效率更高（约 33% 额外存储）。

注：现代 GPU 广泛采用 Mipmap + 各向异性过滤（近似矩形域滤波），而 EWA 仍是高质量软件渲染中的核心算法。